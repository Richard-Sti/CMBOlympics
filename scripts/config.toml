# Configuration for the tSZ mass bin analysis script.

# --- Paths ---
# Base directory used to resolve relative paths in this config.
[paths]
root = "/Users/rstiskalek/Projects/CMBOlympics"
observed_clusters = "data/observed_cluster_masses.toml"
Planck_tSZ_catalogue = "data/HFI_PCCS_SZ-union_R2.08.fits"
MCXC_catalogue = "data/MCXCII_2024.fits"
eRASS_catalogue = "data/erass1cl_primary_v3.2.fits"
# root = "/mnt/extraspace/rstiskalek/CMBOlympics"

# --- Runtime ---
# Global parallelism controls placed near the top for quick access.
[runtime]
n_jobs = 4

# --- Input Maps ---
# Paths to the HEALPix maps for the tSZ signal and random pointings.
[input_map]
signal_map = "data/COM_CompMap_Compton-SZMap-nilc-ymaps_2048_R2.00.fits"
random_pointing = "data/COM_CompMap_Compton-SZMap-nilc-ymaps_2048_R2.00_RAND_POINTING.hdf5"
# FWHM in arcminutes for smoothing the input map.
smooth_fwhm = 9.6

# --- Random Profile Generation Defaults ---
# Default parameters for generate_random_tsz_profiles.py. These control the
# sampling scheme for the random pointing pool. The Planck map path and the
# output HDF5 are taken from [input_map].
[random_profiles]
# Signal aperture radii configuration (arcmin).
theta_min = 1.0
theta_max = 751.0
n_theta = 1001
# Random pointing sampling controls.
n_points = 100_000
abs_b_min = 10.0
fwhm_arcmin = 9.6
seed = 42

# --- Halo Selection Cuts ---
# Criteria for filtering halos from the catalogue before analysis.
[halo_cuts]
r_min = 0.0       # Minimum comoving distance [Mpc/h]
r_max = 150.0     # Maximum comoving distance [Mpc/h]
b_min = 10.0      # Minimum Galactic latitude (absolute value) [degrees]
mass_min = 5e13   # Minimum halo mass (M_200c) [M_sun/h]
mass_max = 1e16   # Maximum halo mass (M_200c) [M_sun/h]
theta_min = 5.0   # Minimum angular size (theta_500) [arcmin]
theta_max = 6000  # Maximum angular size (theta_500) [arcmin]

# --- Mass Binning ---
# Parameters for dividing the selected halos into mass bins.
[mass_bins]
mass_step = 0.2   # Width of mass bins in log10(M_sun/h)
top_counts = [10, 50, 100] # Special high-mass bins containing the top N halos
verbose_bins = true # Print details about the created mass bins

# --- Analysis Parameters ---
# Settings for the main analysis pipeline.
[analysis]
which_simulation = "csiborg2" # Key for the halo catalogue to use (see below)
output_folder = "results" # Folder to save the HDF5 output file
# output_tag = ""             # Optional tag to append to the output filename
matching_pvalue_threshold = 0.05

# Aperture and profile settings
aperture_scale = 2.0          # Aperture size for per-halo p-value, as a multiple of theta_500

# Stacked profile settings
stack_rmin = 0.1  # Minimum radius for stacked profiles (in units of aperture scale)
stack_rmax = 2.0  # Maximum radius for stacked profiles (in units of aperture scale)
stack_n = 501     # Number of radial bins for stacked profiles

# 2D cutout settings
cutout_random_samples = 0    # Number of random cutouts to stack for comparison (0 to disable)
cutout_max_bins = 3          # Only generate cutouts for the first N mass bins
cutout_pixels = 301          # Number of pixels per side for each 2D cutout
cutout_nbins = 256           # Number of bins for the normalized 2D cutout grid
cutout_size_scale = 5        # Cutout size as a multiple of theta_500
cutout_random_abs_b_min = 10 # Minimum Galactic latitude for random cutouts

# Stacking and significance settings
bootstrap = 10_000           # Number of bootstrap resamples for error estimation
high_sample_bins = 3         # Number of high-mass bins to use more random samples for
random_pool_samples_high = 100000 # Number of random stacks for high-mass bins
random_pool_samples_low = 10000   # Number of random stacks for low-mass bins
t_fit_nth_sample = 10        # Down-sampling factor for t-distribution fitting (1 for full)

# General settings
seed = 42   # Random seed for reproducibility

# Output data control
return_individual_profiles = false # Save all individual 1D profiles to the output file
return_random_profiles = false     # Save all individual random 1D profiles to the output file

# --- Mass Scoring ---
# Settings for mass calibration scoring (scripts/score_masses.py)
# Script loops over all catalogues (planck, mcxc, erass) and all simulations (csiborg1, csiborg2, manticore)
[mass_scoring]
match_threshold = [0.05, 0.1]   # p-value threshold(s) for matching (can be single value or list). Used only for greedy/hungarian matching.
# mass_preference_threshold = 0.01 # Mass preference threshold (comment out for None)
z_max = 0.045                   # Maximum redshift for matching
m500_min = 1e14                 # Minimum M500 for matching [M_sun]
use_median_mass = true          # Use median mass from associations
matching_method = "greedy"      # Matching algorithm: greedy, hungarian, or classical
max_angular_sep = 180.0         # Classical matching: max angular separation [arcmin]
max_delta_cz = 1000.0           # Classical matching: max |cz| difference [km/s]
median_halo_tsz_pval_max = 0.1  # Classical matching: max median halo pval (optional)
use_median_halo_tsz_pval = false # Classical matching: minimise median halo pval instead of distance
h = 0.681                       # Hubble parameter for unit conversion
x_pivot = 14.0                  # x-axis pivot for regression (log10 scale)
y_pivot_M500 = 14.0             # y-axis pivot for M500 regression (log10 scale)
y_pivot_L500 = 44.0             # y-axis pivot for L500 regression (log10 scale)
y_pivot_YSZ = -4.0              # y-axis pivot for YSZ regression (log10 scale)
mcmc_warmup = 1000              # Number of MCMC warmup/burn-in steps
mcmc_samples = 10_000           # Number of MCMC sampling steps
mcmc_chains = 1                 # Number of MCMC chains
output_dir = "results/mass_scoring" # Output directory for plots
clear_output_dir = true         # Clear output directory before running

# --- Halo Catalogues ---
# Definitions of available halo catalogues. The key is used in `analysis.which_simulation`.
[halo_catalogues]
min_association_mass = 5e13  # Minimum mass for associations [M_sun/h]
min_fraction_present = 0.5  # Minimum fraction of realisations per association

[halo_catalogues.csiborg1]
fname = "data/csiborg1_fof.hdf5"
nsim = "all"
box_size = 677.7  # [Mpc/h]
omega_m = 0.307
position_key = "Position"
velocity_key = "Velocity"
mass_key = "M500c"
radius_key = "R500c"

[halo_catalogues.csiborg2]
fname = "data/csiborg2_fof.hdf5"
nsim = "all"  # Which simulation number to process ("all" or a specific integer)
position_key = "Coordinates"
velocity_key = "Velocities"
mass_key = "Group_M_Crit500"
radius_key = "Group_R_Crit500"
box_size = 676.6  # [Mpc/h]
omega_m = 0.3111


[halo_catalogues.manticore]
fname = "data/manticore_fof.hdf5"
nsim = "all" # Which simulation number to process ("all" or a specific integer)
position_key = "Coordinates"
velocity_key = "Velocities"
mass_key = "Group_M_Crit500"
radius_key = "Group_R_Crit500"
box_size = 681.0  # [Mpc/h]
omega_m = 0.306
