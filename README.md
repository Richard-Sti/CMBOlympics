# Cosmic Microwave Background Olympics

Toolkit for analysing cosmological “digital twin” simulations and Cosmic Microwave Background (CMB) observations. CMBO is built to measure the thermal Sunyaev–Zel’dovich (tSZ) signal at the locations of haloes drawn from the digital twins.

## Capabilities

### 1D Aperture Profiles & Background Subtraction

The primary analysis method involves extracting 1D profiles of the tSZ signal around the locations of simulated haloes.

- **Aperture Signal:** The signal is calculated as the **mean tSZ value of all pixels within a circular aperture** of a given radius. This is an "enclosed" profile, as implemented in the `cmbo.corr.PointingEnclosedProfile` class.

- **Background Subtraction:** To isolate the halo's signal, a local background is estimated and subtracted. This is done by calculating the mean signal in a concentric annulus surrounding the main aperture (e.g., from 1.0 to 1.5 times the aperture radius) and subtracting this value. This feature is controlled by the `subtract_background` parameter in the profile extraction functions.

- **Per-Halo Significance:** The significance of a tSZ signal at the location of a halo can be quantified by a comparison to random pointings on the sky with the same aperture and background subtraction procedure. This is achieved by comparing the halo's measured profile at some radius against a distribution of profiles obtained from random sky locations (generated by `scripts/generate_random_tsz_profiles.py`). A low p-value indicates a low probability of observing such a signal by chance. Functions like `cmbo.corr.get_pointing_pvalue` facilitate this.

### Stacking and Significance Testing

The purpose of stacking 1D profiles is to detect the average tSZ signal as a function of halo mass. By assessing the significance of this stacked signal, we can determine how well halos of a given mass are correlated with the tSZ signal in the CMB map.

- **Stacking:** Before stacking 1D profiles, they are typically normalized by the angular size of their respective halo (e.g., `theta200`) to allow for a consistent co-addition. The `cmbo.corr.pointing.stack_normalized_profiles` function handles this process.

- **Stacked Significance:** To test the significance of the average tSZ signal from a population of haloes, stacking multiple profiles significantly enhances the signal-to-noise ratio. The significance of this stacked signal is then determined by comparing the stacked halo profile against a stacked profile derived from random sky locations. The signal-to-noise ratio (SNR) is calculated at each radial bin using the formula: `SNR = (stacked_halo_profile - mean_random_profile) / sqrt(halo_profile_error**2 + random_profile_error**2)`. Errors for both halo and random profiles are typically estimated using bootstrap resampling (`cmbo.corr.pointing.bootstrap_profile_mean`).


### 2D Cutouts

In development.

## Installation

```bash
python -m venv cmbo-env
source cmbo-env/bin/activate
python -m pip install --upgrade pip
python -m pip install -e .
```

Installing in editable mode pulls the dependencies declared in `setup.py`. For a full list of dependencies, please refer to the `setup.py` file.
